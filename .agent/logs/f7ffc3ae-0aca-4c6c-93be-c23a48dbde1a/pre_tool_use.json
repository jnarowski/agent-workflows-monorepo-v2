[
  {
    "session_id": "f7ffc3ae-0aca-4c6c-93be-c23a48dbde1a",
    "transcript_path": "/Users/jnarowski/.claude/projects/-Users-jnarowski-Dev-sourceborn-src-agent-workflows-monorepo-v2/f7ffc3ae-0aca-4c6c-93be-c23a48dbde1a.jsonl",
    "cwd": "/Users/jnarowski/Dev/sourceborn/src/agent-workflows-monorepo-v2",
    "permission_mode": "bypassPermissions",
    "hook_event_name": "PreToolUse",
    "tool_name": "Read",
    "tool_input": {
      "file_path": "/Users/jnarowski/Dev/sourceborn/src/agent-workflows-monorepo-v2/apps/web/src/client/hooks/useChatWebSocket.ts"
    }
  },
  {
    "session_id": "f7ffc3ae-0aca-4c6c-93be-c23a48dbde1a",
    "transcript_path": "/Users/jnarowski/.claude/projects/-Users-jnarowski-Dev-sourceborn-src-agent-workflows-monorepo-v2/f7ffc3ae-0aca-4c6c-93be-c23a48dbde1a.jsonl",
    "cwd": "/Users/jnarowski/Dev/sourceborn/src/agent-workflows-monorepo-v2",
    "permission_mode": "bypassPermissions",
    "hook_event_name": "PreToolUse",
    "tool_name": "Read",
    "tool_input": {
      "file_path": "/Users/jnarowski/Dev/sourceborn/src/agent-workflows-monorepo-v2/apps/web/src/server/websocket.ts"
    }
  },
  {
    "session_id": "f7ffc3ae-0aca-4c6c-93be-c23a48dbde1a",
    "transcript_path": "/Users/jnarowski/.claude/projects/-Users-jnarowski-Dev-sourceborn-src-agent-workflows-monorepo-v2/f7ffc3ae-0aca-4c6c-93be-c23a48dbde1a.jsonl",
    "cwd": "/Users/jnarowski/Dev/sourceborn/src/agent-workflows-monorepo-v2",
    "permission_mode": "bypassPermissions",
    "hook_event_name": "PreToolUse",
    "tool_name": "Edit",
    "tool_input": {
      "file_path": "/Users/jnarowski/Dev/sourceborn/src/agent-workflows-monorepo-v2/apps/web/src/client/hooks/useChatWebSocket.ts",
      "old_string": "  const wsRef = useRef<WebSocket | null>(null);\n  const reconnectTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const reconnectAttemptsRef = useRef(0);\n  const maxReconnectAttempts = 5;\n\n  const { setWebSocketConnection, removeWebSocketConnection, updateSessionMetadata } = useChatContext();\n\n  const connect = useCallback(() => {\n    if (!sessionId || !projectId) return;",
      "new_string": "  const wsRef = useRef<WebSocket | null>(null);\n  const reconnectTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const reconnectAttemptsRef = useRef(0);\n  const maxReconnectAttempts = 5;\n  const isReconnectingRef = useRef(false);\n  const isMountedRef = useRef(true);\n\n  const { setWebSocketConnection, removeWebSocketConnection, updateSessionMetadata } = useChatContext();\n\n  const connect = useCallback(() => {\n    if (!sessionId || !projectId || !isMountedRef.current) return;"
    }
  },
  {
    "session_id": "f7ffc3ae-0aca-4c6c-93be-c23a48dbde1a",
    "transcript_path": "/Users/jnarowski/.claude/projects/-Users-jnarowski-Dev-sourceborn-src-agent-workflows-monorepo-v2/f7ffc3ae-0aca-4c6c-93be-c23a48dbde1a.jsonl",
    "cwd": "/Users/jnarowski/Dev/sourceborn/src/agent-workflows-monorepo-v2",
    "permission_mode": "bypassPermissions",
    "hook_event_name": "PreToolUse",
    "tool_name": "Edit",
    "tool_input": {
      "file_path": "/Users/jnarowski/Dev/sourceborn/src/agent-workflows-monorepo-v2/apps/web/src/client/hooks/useChatWebSocket.ts",
      "old_string": "    // Close existing connection if any\n    if (wsRef.current) {\n      wsRef.current.close();\n    }",
      "new_string": "    // Close existing connection if any\n    if (wsRef.current) {\n      // Remove listeners to prevent reconnect loop\n      wsRef.current.onclose = null;\n      wsRef.current.onerror = null;\n      wsRef.current.close();\n      wsRef.current = null;\n    }\n\n    // Clear any pending reconnect timeout\n    if (reconnectTimeoutRef.current) {\n      clearTimeout(reconnectTimeoutRef.current);\n      reconnectTimeoutRef.current = null;\n    }"
    }
  },
  {
    "session_id": "f7ffc3ae-0aca-4c6c-93be-c23a48dbde1a",
    "transcript_path": "/Users/jnarowski/.claude/projects/-Users-jnarowski-Dev-sourceborn-src-agent-workflows-monorepo-v2/f7ffc3ae-0aca-4c6c-93be-c23a48dbde1a.jsonl",
    "cwd": "/Users/jnarowski/Dev/sourceborn/src/agent-workflows-monorepo-v2",
    "permission_mode": "bypassPermissions",
    "hook_event_name": "PreToolUse",
    "tool_name": "Edit",
    "tool_input": {
      "file_path": "/Users/jnarowski/Dev/sourceborn/src/agent-workflows-monorepo-v2/apps/web/src/client/hooks/useChatWebSocket.ts",
      "old_string": "    ws.onclose = () => {\n      console.log('WebSocket closed for session:', sessionId);\n      setIsConnected(false);\n      wsRef.current = null;\n      removeWebSocketConnection(sessionId);\n\n      // Attempt to reconnect with exponential backoff\n      if (reconnectAttemptsRef.current < maxReconnectAttempts) {\n        const delay = Math.min(1000 * Math.pow(2, reconnectAttemptsRef.current), 10000);\n        reconnectAttemptsRef.current += 1;\n\n        reconnectTimeoutRef.current = setTimeout(() => {\n          console.log(`Reconnecting... (attempt ${reconnectAttemptsRef.current})`);\n          connect();\n        }, delay);\n      }\n    };\n  }, [sessionId, projectId, setWebSocketConnection, removeWebSocketConnection, updateSessionMetadata]);",
      "new_string": "    ws.onclose = () => {\n      console.log('WebSocket closed for session:', sessionId);\n      setIsConnected(false);\n\n      // Only clear wsRef if it's the current connection\n      if (wsRef.current === ws) {\n        wsRef.current = null;\n      }\n      removeWebSocketConnection(sessionId);\n\n      // Only attempt to reconnect if not already reconnecting and component is still mounted\n      if (!isReconnectingRef.current &&\n          isMountedRef.current &&\n          reconnectAttemptsRef.current < maxReconnectAttempts) {\n        isReconnectingRef.current = true;\n        const delay = Math.min(1000 * Math.pow(2, reconnectAttemptsRef.current), 10000);\n        reconnectAttemptsRef.current += 1;\n\n        reconnectTimeoutRef.current = setTimeout(() => {\n          console.log(`Reconnecting... (attempt ${reconnectAttemptsRef.current})`);\n          isReconnectingRef.current = false;\n          if (isMountedRef.current) {\n            connect();\n          }\n        }, delay);\n      }\n    };\n  }, [sessionId, projectId, setWebSocketConnection, removeWebSocketConnection, updateSessionMetadata]);"
    }
  },
  {
    "session_id": "f7ffc3ae-0aca-4c6c-93be-c23a48dbde1a",
    "transcript_path": "/Users/jnarowski/.claude/projects/-Users-jnarowski-Dev-sourceborn-src-agent-workflows-monorepo-v2/f7ffc3ae-0aca-4c6c-93be-c23a48dbde1a.jsonl",
    "cwd": "/Users/jnarowski/Dev/sourceborn/src/agent-workflows-monorepo-v2",
    "permission_mode": "bypassPermissions",
    "hook_event_name": "PreToolUse",
    "tool_name": "Edit",
    "tool_input": {
      "file_path": "/Users/jnarowski/Dev/sourceborn/src/agent-workflows-monorepo-v2/apps/web/src/client/hooks/useChatWebSocket.ts",
      "old_string": "  // Connect on mount and cleanup on unmount\n  useEffect(() => {\n    connect();\n\n    return () => {\n      if (reconnectTimeoutRef.current) {\n        clearTimeout(reconnectTimeoutRef.current);\n      }\n      if (wsRef.current) {\n        wsRef.current.close();\n        wsRef.current = null;\n      }\n    };\n  }, [connect]);",
      "new_string": "  // Connect on mount and cleanup on unmount\n  useEffect(() => {\n    isMountedRef.current = true;\n    connect();\n\n    return () => {\n      isMountedRef.current = false;\n      isReconnectingRef.current = false;\n\n      if (reconnectTimeoutRef.current) {\n        clearTimeout(reconnectTimeoutRef.current);\n        reconnectTimeoutRef.current = null;\n      }\n      if (wsRef.current) {\n        // Remove listeners to prevent reconnect on unmount\n        wsRef.current.onclose = null;\n        wsRef.current.onerror = null;\n        wsRef.current.close();\n        wsRef.current = null;\n      }\n    };\n  }, [sessionId, projectId]); // Only depend on sessionId and projectId, not connect"
    }
  }
]