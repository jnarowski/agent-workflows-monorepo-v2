# Feature: Git Source Control

## What We're Building

A comprehensive git source control interface integrated into the project detail pages. Users can view and stage changed files with inline diffs, manage branches, commit changes with custom messages, view commit history with expandable diffs, push/fetch from remote, and create pull requests via GitHub CLI or web UI fallback.

## User Story

As a developer using the project workspace
I want to manage git operations (stage, commit, branch, push, view history) directly in the web UI
So that I can track changes and collaborate without switching to terminal or external git tools

## Technical Approach

Extend existing `git.service.ts` with simple-git operations for status, staging, commits, branches, push/fetch, and history. Create new REST API routes under `/api/projects/:id/git/*` following existing route patterns. Build React components with inline collapsible diffs (reusing existing `DiffViewer`), tab navigation (Changes/History), and local `useState` for UI. Use React Query for server state management. Implement hybrid PR creation: try `gh` CLI first, fallback to GitHub web URL. Auto-refresh git status, clear selections after commit, pre-fill PR with commit messages.

## Files to Touch

### Existing Files

- `apps/web/src/server/services/git.service.ts` - Add all git operations (status, stage, commit, branches, push, fetch, history, diffs, PR)
- `apps/web/src/server/routes/index.ts` - Register new git routes
- `apps/web/src/client/App.tsx` - Add source-control route in project detail routes
- `apps/web/src/client/pages/projects/sessions/components/DiffViewer.tsx` - Reuse for file diffs (no changes needed, just import)

### New Files

- `apps/web/src/shared/types/git.types.ts` - TypeScript interfaces for git operations
- `apps/web/src/server/routes/git.ts` - API routes for all git operations
- `apps/web/src/server/schemas/git.ts` - Zod validation schemas for git endpoints
- `apps/web/src/client/pages/projects/git/ProjectSourceControl.tsx` - Main page with tabs and state management
- `apps/web/src/client/pages/projects/git/components/GitTopBar.tsx` - Branch selector, Push/Fetch/Refresh buttons
- `apps/web/src/client/pages/projects/git/components/ChangesView.tsx` - File list with checkboxes and commit controls
- `apps/web/src/client/pages/projects/git/components/FileChangeItem.tsx` - Single file item with collapsible diff
- `apps/web/src/client/pages/projects/git/components/HistoryView.tsx` - Commit list with pagination
- `apps/web/src/client/pages/projects/git/components/CommitCard.tsx` - Collapsible commit card
- `apps/web/src/client/pages/projects/git/components/CommitDiffView.tsx` - Expanded commit details with diffs
- `apps/web/src/client/pages/projects/git/components/CreateBranchDialog.tsx` - Dialog for creating new branch
- `apps/web/src/client/pages/projects/git/components/CreatePullRequestDialog.tsx` - Dialog for PR creation with pre-filled data
- `apps/web/src/client/pages/projects/git/hooks/useGitOperations.ts` - React Query hooks for all git operations

## Implementation Plan

### Phase 1: Foundation

Create shared TypeScript types for all git operations (file status, branches, commits, diffs, PR data). Extend git.service.ts with comprehensive simple-git functions: status, branch list/create/switch, staging, commits, push/fetch, file diffs, commit history, commit diffs, and PR data/creation. Add `gh` CLI detection. Create Zod schemas for request/response validation. Set up basic API routes structure.

### Phase 2: Core Implementation

Build all API endpoints with authentication, validation, and error handling. Create React Query hooks wrapping each git operation with proper cache invalidation. Build main `ProjectSourceControl` page shell with tab navigation and local state management. Implement Changes tab with file list, checkboxes, inline diffs, and commit controls. Implement History tab with paginated commits, collapsible cards, and commit diff display.

### Phase 3: Integration

Build GitTopBar with branch selector dropdown and action buttons. Implement branch operations (create/switch) with dialog. Add Push/Fetch functionality with status badges. Implement PR creation with hybrid approach (gh CLI + web fallback) and pre-fill dialog. Add route to App.tsx. Wire up all interactions, state transitions, and toast notifications. Test full workflows end-to-end.

## Step by Step Tasks

**IMPORTANT: Execute every step in order, top to bottom**

### 1: Create Shared Types

<!-- prettier-ignore -->
- [x] 1.1 Create git.types.ts with all TypeScript interfaces
        - File: `apps/web/src/shared/types/git.types.ts`
        - Define `GitFileStatus`: path (string), status ('M'|'A'|'D'|'??'|'R'|'C'), staged (boolean)
        - Define `GitStatus`: branch (string), files (GitFileStatus[]), ahead (number), behind (number), isRepo (boolean)
        - Define `GitBranch`: name (string), current (boolean)
        - Define `GitCommit`: hash (string), shortHash (string), message (string), author (string), email (string), date (string), relativeDate (string)
        - Define `GitCommitDiff`: hash, message, author, email, date, filesChanged (number), insertions (number), deletions (number), diff (string)
        - Define `PrData`: title (string), description (string), commits (GitCommit[])
        - Define `PrResult`: success (boolean), prUrl (optional string), useGhCli (boolean), error (optional string)
        - Export all interfaces

#### Completion Notes

- Created comprehensive TypeScript types for all git operations
- Added GitFileStatusType union type for better type safety
- All interfaces exported and ready for use across frontend and backend

### 2: Extend Git Service - Core Operations

<!-- prettier-ignore -->
- [x] 2.1 Add getGitStatus function
        - File: `apps/web/src/server/services/git.service.ts`
        - Import simpleGit, GitStatus, GitFileStatus types
        - Function signature: `async function getGitStatus(projectPath: string, logger?: FastifyBaseLogger): Promise<GitStatus>`
        - Check if directory is git repo with `git.checkIsRepo()`
        - Get status with `git.status()`
        - Map files to GitFileStatus format (handle staged vs unstaged)
        - Return GitStatus with branch, files, ahead, behind counts
        - Handle non-repo gracefully (return isRepo: false)
- [x] 2.2 Add getBranches function
        - Function signature: `async function getBranches(projectPath: string, logger?: FastifyBaseLogger): Promise<GitBranch[]>`
        - Use `git.branch()` to get all branches
        - Map to GitBranch format with current flag
        - Return array of branches sorted alphabetically
- [x] 2.3 Add createAndSwitchBranch function
        - Function signature: `async function createAndSwitchBranch(projectPath: string, branchName: string, from?: string, logger?: FastifyBaseLogger): Promise<GitBranch>`
        - Validate branch name (no spaces, special chars)
        - Use `git.checkoutLocalBranch(branchName, from)` to create and switch
        - Return new branch info
- [x] 2.4 Add switchBranch function
        - Function signature: `async function switchBranch(projectPath: string, branchName: string, logger?: FastifyBaseLogger): Promise<GitBranch>`
        - Use `git.checkout(branchName)`
        - Return branch info after switch
- [x] 2.5 Add stageFiles function
        - Function signature: `async function stageFiles(projectPath: string, files: string[], logger?: FastifyBaseLogger): Promise<void>`
        - Use `git.add(files)` to stage multiple files
        - Handle errors gracefully
- [x] 2.6 Add unstageFiles function
        - Function signature: `async function unstageFiles(projectPath: string, files: string[], logger?: FastifyBaseLogger): Promise<void>`
        - Use `git.reset(['HEAD', ...files])` to unstage
        - Handle errors gracefully
- [x] 2.7 Add commitChanges function
        - Function signature: `async function commitChanges(projectPath: string, message: string, files: string[], logger?: FastifyBaseLogger): Promise<string>`
        - Stage specified files if not already staged
        - Use `git.commit(message, files)` to create commit
        - Return commit hash

#### Completion Notes

- Added all core git operations: status, branches, create/switch branch, stage/unstage, commit
- Properly handles staged vs unstaged files in status
- Branch name validation prevents invalid characters
- All functions follow error handling pattern with logger

### 3: Extend Git Service - Remote & History

<!-- prettier-ignore -->
- [x] 3.1 Add pushToRemote function
        - File: `apps/web/src/server/services/git.service.ts`
        - Function signature: `async function pushToRemote(projectPath: string, branch: string, remote: string = 'origin', logger?: FastifyBaseLogger): Promise<void>`
        - Use `git.push(remote, branch)` to push branch
        - Handle upstream tracking if needed
        - Log push output
- [x] 3.2 Add fetchFromRemote function
        - Function signature: `async function fetchFromRemote(projectPath: string, remote: string = 'origin', logger?: FastifyBaseLogger): Promise<void>`
        - Use `git.fetch(remote)` to fetch latest
        - Log fetch output
- [x] 3.3 Add getFileDiff function
        - Function signature: `async function getFileDiff(projectPath: string, filepath: string, logger?: FastifyBaseLogger): Promise<string>`
        - Use `git.diff(['--', filepath])` to get working tree diff
        - Return raw diff string
- [x] 3.4 Add getCommitHistory function
        - Function signature: `async function getCommitHistory(projectPath: string, limit: number = 100, offset: number = 0, logger?: FastifyBaseLogger): Promise<GitCommit[]>`
        - Use `git.log({ maxCount: limit, from: offset })` to get commits
        - Map to GitCommit format with relative dates
        - Calculate relative dates ("3 days ago") using date-fns or similar
        - Return array of commits
- [x] 3.5 Add getCommitDiff function
        - Function signature: `async function getCommitDiff(projectPath: string, commitHash: string, logger?: FastifyBaseLogger): Promise<GitCommitDiff>`
        - Use `git.show([commitHash, '--stat', '--format=%H%n%an%n%ae%n%at%n%s%n%b'])` to get commit details
        - Use `git.diff([commitHash + '^', commitHash])` for full diff
        - Parse stats for filesChanged, insertions, deletions counts
        - Return GitCommitDiff object

#### Completion Notes

- Added push/fetch operations with upstream tracking
- File diff returns raw unified diff string for use with DiffViewer
- Commit history uses date-fns for relative date formatting
- Commit diff includes full metadata and parsed stats (files/insertions/deletions)

### 4: Extend Git Service - PR Operations

<!-- prettier-ignore -->
- [x] 4.1 Add getCommitsSinceBase function
        - File: `apps/web/src/server/services/git.service.ts`
        - Function signature: `async function getCommitsSinceBase(projectPath: string, baseBranch: string = 'main', logger?: FastifyBaseLogger): Promise<GitCommit[]>`
        - Use `git.log([baseBranch + '..HEAD'])` to get commits since branch point
        - Map to GitCommit format
        - Return array for PR description
- [x] 4.2 Add checkGhCliAvailable function
        - Function signature: `async function checkGhCliAvailable(projectPath: string, logger?: FastifyBaseLogger): Promise<boolean>`
        - Run shell command: `gh auth status` from projectPath
        - Return true if exit code 0 (authenticated), false otherwise
        - Log availability status
- [x] 4.3 Add createPullRequest function
        - Function signature: `async function createPullRequest(projectPath: string, title: string, description: string, baseBranch: string = 'main', logger?: FastifyBaseLogger): Promise<PrResult>`
        - Check gh CLI availability with checkGhCliAvailable()
        - If available: run `gh pr create --title "${title}" --body "${description}" --base ${baseBranch} --web`
        - If successful: return { success: true, useGhCli: true, prUrl: <from gh output> }
        - If gh not available: construct GitHub compare URL from git remote origin
        - Parse remote URL to get owner/repo
        - Return { success: true, useGhCli: false, prUrl: `https://github.com/owner/repo/compare/${baseBranch}...${currentBranch}` }
        - Handle errors and return { success: false, error: message }
- [x] 4.4 Export all new functions from git.service.ts
        - Add export statements for all new functions
        - Ensure existing getCurrentBranch is still exported

#### Completion Notes

- Get commits since base for PR pre-fill data
- GitHub CLI detection with fallback to web compare URL
- PR creation supports both HTTPS and SSH remote formats
- Hybrid approach: tries gh CLI first, gracefully falls back to GitHub web UI
- All functions exported and ready for API routes

### 5: Create Zod Schemas

<!-- prettier-ignore -->
- [x] 5.1 Create git.ts schemas file
        - File: `apps/web/src/server/schemas/git.ts`
        - Import z from 'zod'
        - Define gitProjectParamsSchema: z.object({ id: z.string() })
        - Define gitFilePathQuerySchema: z.object({ path: z.string() })
        - Define gitBranchBodySchema: z.object({ name: z.string().min(1), from: z.string().optional() })
        - Define gitSwitchBranchBodySchema: z.object({ name: z.string().min(1) })
        - Define gitStageFilesBodySchema: z.object({ files: z.array(z.string()).min(1) })
        - Define gitCommitBodySchema: z.object({ message: z.string().min(1), files: z.array(z.string()).min(1) })
        - Define gitPushBodySchema: z.object({ branch: z.string(), remote: z.string().optional() })
        - Define gitFetchBodySchema: z.object({ remote: z.string().optional() })
        - Define gitHistoryQuerySchema: z.object({ limit: z.coerce.number().min(1).max(500).default(100), offset: z.coerce.number().min(0).default(0) })
        - Define gitCommitParamsSchema: z.object({ id: z.string(), hash: z.string() })
        - Define gitPrDataQuerySchema: z.object({ base: z.string().default('main') })
        - Define gitCreatePrBodySchema: z.object({ title: z.string().min(1), description: z.string(), baseBranch: z.string().default('main') })
        - Export all schemas

#### Completion Notes

- Created comprehensive Zod schemas for all git API endpoints
- Request validation for params, query strings, and body payloads
- Proper defaults and constraints (e.g., history limit max 500)

### 6: Create Git API Routes

<!-- prettier-ignore -->
- [ ] 6.1 Create git.ts routes file
        - File: `apps/web/src/server/routes/git.ts`
        - Import FastifyInstance from 'fastify'
        - Import all service functions from @/server/services/git.service
        - Import all schemas from @/server/schemas/git
        - Import buildErrorResponse from @/server/utils/error
        - Import getProjectById from @/server/services/project
        - Define async function gitRoutes(fastify: FastifyInstance)
- [ ] 6.2 Implement GET /api/projects/:id/git/status
        - Validate params with gitProjectParamsSchema
        - Add preHandler: fastify.authenticate
        - Get project by id, return 404 if not found
        - Call getGitStatus(project.path, fastify.log)
        - Return { data: status }
        - Error handling for non-repo, permission issues
- [ ] 6.3 Implement GET /api/projects/:id/git/branches
        - Validate params with gitProjectParamsSchema
        - Add authentication
        - Get project, call getBranches(project.path, fastify.log)
        - Return { data: branches }
- [ ] 6.4 Implement POST /api/projects/:id/git/branch (create and switch)
        - Validate params and body with gitBranchBodySchema
        - Add authentication
        - Get project, call createAndSwitchBranch(project.path, name, from, fastify.log)
        - Return { data: branch } with 201 status
- [ ] 6.5 Implement POST /api/projects/:id/git/branch/switch
        - Validate params and body with gitSwitchBranchBodySchema
        - Add authentication
        - Get project, call switchBranch(project.path, name, fastify.log)
        - Return { data: branch }
- [ ] 6.6 Implement POST /api/projects/:id/git/stage
        - Validate params and body with gitStageFilesBodySchema
        - Add authentication
        - Get project, call stageFiles(project.path, files, fastify.log)
        - Return { success: true }
- [ ] 6.7 Implement POST /api/projects/:id/git/unstage
        - Validate params and body with gitStageFilesBodySchema (same schema)
        - Add authentication
        - Get project, call unstageFiles(project.path, files, fastify.log)
        - Return { success: true }
- [ ] 6.8 Implement POST /api/projects/:id/git/commit
        - Validate params and body with gitCommitBodySchema
        - Add authentication
        - Get project, call commitChanges(project.path, message, files, fastify.log)
        - Return { data: { hash } } with 201 status
- [ ] 6.9 Implement POST /api/projects/:id/git/push
        - Validate params and body with gitPushBodySchema
        - Add authentication
        - Get project, call pushToRemote(project.path, branch, remote, fastify.log)
        - Return { success: true }
- [ ] 6.10 Implement POST /api/projects/:id/git/fetch
        - Validate params and body with gitFetchBodySchema
        - Add authentication
        - Get project, call fetchFromRemote(project.path, remote, fastify.log)
        - Return { success: true }
- [ ] 6.11 Implement GET /api/projects/:id/git/diff
        - Validate params with gitProjectParamsSchema, query with gitFilePathQuerySchema
        - Add authentication
        - Get project, call getFileDiff(project.path, path, fastify.log)
        - Return { data: { diff } }
- [ ] 6.12 Implement GET /api/projects/:id/git/history
        - Validate params with gitProjectParamsSchema, query with gitHistoryQuerySchema
        - Add authentication
        - Get project, call getCommitHistory(project.path, limit, offset, fastify.log)
        - Return { data: commits }
- [ ] 6.13 Implement GET /api/projects/:id/git/commit/:hash
        - Validate params with gitCommitParamsSchema
        - Add authentication
        - Get project, call getCommitDiff(project.path, hash, fastify.log)
        - Return { data: commitDiff }
- [ ] 6.14 Implement GET /api/projects/:id/git/pr-data
        - Validate params with gitProjectParamsSchema, query with gitPrDataQuerySchema
        - Add authentication
        - Get project, call getCommitsSinceBase(project.path, base, fastify.log)
        - Construct title from most recent commit message
        - Construct description from all commit messages (numbered list)
        - Return { data: { title, description, commits } }
- [ ] 6.15 Implement POST /api/projects/:id/git/pr
        - Validate params with gitProjectParamsSchema, body with gitCreatePrBodySchema
        - Add authentication
        - Get project, call createPullRequest(project.path, title, description, baseBranch, fastify.log)
        - Return { data: prResult }
- [ ] 6.16 Export gitRoutes function
        - Add: export { gitRoutes }

#### Completion Notes

### 7: Register Git Routes

<!-- prettier-ignore -->
- [ ] 7.1 Register git routes in server
        - File: `apps/web/src/server/routes/index.ts`
        - Import gitRoutes from @/server/routes/git
        - Add: await gitRoutes(fastify)
        - Place after session routes registration
        - Save file

#### Completion Notes

### 8: Create React Query Hooks

<!-- prettier-ignore -->
- [ ] 8.1 Create useGitOperations.ts hook file
        - File: `apps/web/src/client/pages/projects/git/hooks/useGitOperations.ts`
        - Import useQuery, useMutation, useQueryClient from @tanstack/react-query
        - Import api from @/client/lib/api-client
        - Import all git types from @/shared/types/git.types
        - Import toast from sonner
- [ ] 8.2 Implement useGitStatus query hook
        - Function: `useGitStatus(projectId: string | undefined)`
        - Query key: ['git', 'status', projectId]
        - Query function: fetch `/api/projects/${projectId}/git/status`
        - Return GitStatus from response.data
        - Set enabled: !!projectId
        - Set refetchInterval: 30000 (auto-refresh every 30s)
- [ ] 8.3 Implement useBranches query hook
        - Function: `useBranches(projectId: string | undefined)`
        - Query key: ['git', 'branches', projectId]
        - Query function: fetch `/api/projects/${projectId}/git/branches`
        - Return GitBranch[] from response.data
        - Set enabled: !!projectId
- [ ] 8.4 Implement useFileDiff query hook
        - Function: `useFileDiff(projectId: string | undefined, filepath: string | null)`
        - Query key: ['git', 'diff', projectId, filepath]
        - Query function: fetch `/api/projects/${projectId}/git/diff?path=${filepath}`
        - Return diff string from response.data.diff
        - Set enabled: !!projectId && !!filepath
- [ ] 8.5 Implement useCommitHistory query hook
        - Function: `useCommitHistory(projectId: string | undefined, limit: number = 100, offset: number = 0)`
        - Query key: ['git', 'history', projectId, limit, offset]
        - Query function: fetch `/api/projects/${projectId}/git/history?limit=${limit}&offset=${offset}`
        - Return GitCommit[] from response.data
        - Set enabled: !!projectId
- [ ] 8.6 Implement useCommitDiff query hook
        - Function: `useCommitDiff(projectId: string | undefined, commitHash: string | null)`
        - Query key: ['git', 'commit', projectId, commitHash]
        - Query function: fetch `/api/projects/${projectId}/git/commit/${commitHash}`
        - Return GitCommitDiff from response.data
        - Set enabled: !!projectId && !!commitHash
- [ ] 8.7 Implement usePrData query hook
        - Function: `usePrData(projectId: string | undefined, baseBranch: string = 'main', enabled: boolean = false)`
        - Query key: ['git', 'pr-data', projectId, baseBranch]
        - Query function: fetch `/api/projects/${projectId}/git/pr-data?base=${baseBranch}`
        - Return PrData from response.data
        - Set enabled: enabled && !!projectId
- [ ] 8.8 Implement useCreateBranch mutation hook
        - Function: `useCreateBranch()`
        - Mutation function: POST `/api/projects/:projectId/git/branch` with { name, from }
        - On success: invalidate ['git', 'branches', projectId] and ['git', 'status', projectId]
        - Show success toast: "Branch created: {name}"
        - Return mutation object
- [ ] 8.9 Implement useSwitchBranch mutation hook
        - Function: `useSwitchBranch()`
        - Mutation function: POST `/api/projects/:projectId/git/branch/switch` with { name }
        - On success: invalidate ['git', 'branches', projectId] and ['git', 'status', projectId]
        - Show success toast: "Switched to branch: {name}"
        - Return mutation object
- [ ] 8.10 Implement useStageFiles mutation hook
        - Function: `useStageFiles()`
        - Mutation function: POST `/api/projects/:projectId/git/stage` with { files }
        - On success: invalidate ['git', 'status', projectId]
        - No toast (silent operation)
        - Return mutation object
- [ ] 8.11 Implement useUnstageFiles mutation hook
        - Function: `useUnstageFiles()`
        - Mutation function: POST `/api/projects/:projectId/git/unstage` with { files }
        - On success: invalidate ['git', 'status', projectId]
        - No toast (silent operation)
        - Return mutation object
- [ ] 8.12 Implement useCommit mutation hook
        - Function: `useCommit()`
        - Mutation function: POST `/api/projects/:projectId/git/commit` with { message, files }
        - On success: invalidate ['git', 'status', projectId] and ['git', 'history', projectId]
        - Show success toast: "Committed successfully"
        - Return mutation object with commit hash
- [ ] 8.13 Implement usePush mutation hook
        - Function: `usePush()`
        - Mutation function: POST `/api/projects/:projectId/git/push` with { branch, remote }
        - On success: invalidate ['git', 'status', projectId]
        - Show success toast: "Pushed to remote"
        - Return mutation object
- [ ] 8.14 Implement useFetch mutation hook
        - Function: `useFetch()`
        - Mutation function: POST `/api/projects/:projectId/git/fetch` with { remote }
        - On success: invalidate ['git', 'status', projectId] and ['git', 'history', projectId]
        - Show success toast: "Fetched from remote"
        - Return mutation object
- [ ] 8.15 Implement useCreatePr mutation hook
        - Function: `useCreatePr()`
        - Mutation function: POST `/api/projects/:projectId/git/pr` with { title, description, baseBranch }
        - On success: open prUrl in new tab if provided
        - Show success toast with PR link
        - Handle useGhCli flag in response
        - Return mutation object with PrResult

#### Completion Notes

### 9: Create Main Page Layout

<!-- prettier-ignore -->
- [ ] 9.1 Create ProjectSourceControl.tsx main page
        - File: `apps/web/src/client/pages/projects/git/ProjectSourceControl.tsx`
        - Import useState, useParams from react/react-router-dom
        - Import Tabs, TabsList, TabsTrigger, TabsContent from @/client/components/ui/tabs
        - Import all git hooks from ./hooks/useGitOperations
        - Import GitTopBar component (to be created)
        - Import ChangesView, HistoryView components (to be created)
- [ ] 9.2 Set up local state management
        - Define state: activeTab: 'changes' | 'history' (default: 'changes')
        - Changes tab state: selectedFiles (Set<string>), expandedFiles (Set<string>), commitMessage (string)
        - History tab state: expandedCommits (Set<string>)
        - Extract projectId from useParams<{ id: string }>()
- [ ] 9.3 Implement helper functions
        - handleToggleFile(filepath: string) - toggle in selectedFiles Set
        - handleToggleFileExpand(filepath: string) - toggle in expandedFiles Set
        - handleSelectAll() - add all unstaged files to selectedFiles
        - handleDeselectAll() - clear selectedFiles
        - handleToggleCommitExpand(commitHash: string) - toggle in expandedCommits Set
- [ ] 9.4 Build main layout structure
        - Wrapper div with h-full flex flex-col
        - GitTopBar component at top
        - Tabs component with activeTab state
        - TabsList with "Changes" and "History" triggers
        - TabsContent for "changes" rendering ChangesView
        - TabsContent for "history" rendering HistoryView
- [ ] 9.5 Wire up GitTopBar props
        - Pass: projectId, branches from useBranches, currentBranch from useGitStatus
        - Pass: ahead/behind counts from useGitStatus
        - Pass: onSwitchBranch, onCreateBranch, onPush, onFetch, onRefresh callbacks
- [ ] 9.6 Wire up ChangesView props
        - Pass: projectId, files from useGitStatus, selectedFiles, expandedFiles, commitMessage
        - Pass: onToggleFile, onToggleExpand, onSelectAll, onDeselectAll
        - Pass: onCommitMessageChange, onCommit callback
        - Implement onCommit: call useCommit mutation, clear selections and message on success
- [ ] 9.7 Wire up HistoryView props
        - Pass: projectId, expandedCommits, onToggleExpand callback
- [ ] 9.8 Export default ProjectSourceControl
        - Add export default statement

#### Completion Notes

### 10: Create GitTopBar Component

<!-- prettier-ignore -->
- [ ] 10.1 Create GitTopBar.tsx component
        - File: `apps/web/src/client/pages/projects/git/components/GitTopBar.tsx`
        - Import Button, Badge from ui components
        - Import Select components for branch dropdown
        - Import GitBranch, ArrowUpCircle, ArrowDownCircle, RefreshCw icons from lucide-react
        - Import CreateBranchDialog, CreatePullRequestDialog components
        - Import useState for dialog states
- [ ] 10.2 Define component props interface
        - projectId: string | undefined
        - currentBranch: string | undefined
        - branches: GitBranch[] | undefined
        - ahead: number
        - behind: number
        - onSwitchBranch: (branchName: string) => void
        - onCreateBranch: (name: string, from?: string) => void
        - onPush: () => void
        - onFetch: () => void
        - onRefresh: () => void
        - onCreatePr: () => void
- [ ] 10.3 Build branch selector dropdown
        - Use Select component with value={currentBranch}
        - SelectTrigger with branch icon + current branch name
        - SelectContent with list of branches
        - Show checkmark icon next to current branch
        - Add separator and "Create new branch" option at bottom
        - onClick "Create new branch" opens CreateBranchDialog
- [ ] 10.4 Build action buttons
        - Push button with ArrowUpCircle icon
        - Show badge with ahead count if ahead > 0
        - Disabled if ahead === 0
        - Fetch button with ArrowDownCircle icon
        - Show badge with behind count if behind > 0
        - Refresh button with RefreshCw icon
        - Create PR button (only show if ahead > 0)
- [ ] 10.5 Implement button handlers
        - Push button calls onPush
        - Fetch button calls onFetch
        - Refresh button calls onRefresh
        - Create PR button opens CreatePullRequestDialog
- [ ] 10.6 Style top bar layout
        - Flex row with space-between
        - Padding and border-bottom
        - Branch selector on left
        - Action buttons grouped on right

#### Completion Notes

### 11: Create ChangesView Component

<!-- prettier-ignore -->
- [ ] 11.1 Create ChangesView.tsx component
        - File: `apps/web/src/client/pages/projects/git/components/ChangesView.tsx`
        - Import Button, Textarea from ui components
        - Import FileChangeItem component (to be created)
        - Import GitFileStatus type
- [ ] 11.2 Define component props interface
        - projectId: string | undefined
        - files: GitFileStatus[] | undefined
        - selectedFiles: Set<string>
        - expandedFiles: Set<string>
        - commitMessage: string
        - onToggleFile: (filepath: string) => void
        - onToggleExpand: (filepath: string) => void
        - onSelectAll: () => void
        - onDeselectAll: () => void
        - onCommitMessageChange: (message: string) => void
        - onCommit: () => void
- [ ] 11.3 Build commit message section at top
        - Label: "Commit message"
        - Textarea with placeholder, value={commitMessage}, onChange
        - Rows: 3
- [ ] 11.4 Build commit controls below textarea
        - Commit button: primary, disabled if selectedFiles.size === 0 || !commitMessage.trim()
        - Text: "Commit ({selectedFiles.size} files)"
        - onClick calls onCommit
- [ ] 11.5 Build file list header
        - Show file count: "{files?.length || 0} changed files"
        - "Select All" / "Deselect All" buttons
- [ ] 11.6 Build file list
        - Map over files array
        - Render FileChangeItem for each file
        - Pass: file, selected, expanded, projectId
        - Pass: onToggle, onToggleExpand callbacks
- [ ] 11.7 Handle empty state
        - Show "No changes detected" message when files.length === 0
        - Show icon (CheckCircle or similar)
        - Center in content area

#### Completion Notes

### 12: Create FileChangeItem Component

<!-- prettier-ignore -->
- [ ] 12.1 Create FileChangeItem.tsx component
        - File: `apps/web/src/client/pages/projects/git/components/FileChangeItem.tsx`
        - Import Checkbox, Badge, Collapsible components from ui
        - Import ChevronRight icon from lucide-react
        - Import DiffViewer from @/client/pages/projects/sessions/components/DiffViewer
        - Import useFileDiff hook
        - Import GitFileStatus type
- [ ] 12.2 Define component props interface
        - file: GitFileStatus
        - selected: boolean
        - expanded: boolean
        - projectId: string | undefined
        - onToggle: () => void
        - onToggleExpand: () => void
- [ ] 12.3 Fetch diff when expanded
        - Use useFileDiff(projectId, expanded ? file.path : null)
        - Only fetch when expanded is true
- [ ] 12.4 Build file item header
        - Collapsible trigger with flex row layout
        - Checkbox (checked={selected}, onChange={onToggle})
        - Status badge (M/A/D/??) with appropriate color
        - Filename in monospace font
        - ChevronRight icon (rotates 90deg when expanded)
        - onClick header toggles expand (except checkbox)
- [ ] 12.5 Build collapsible content
        - CollapsibleContent wraps diff
        - Show loading skeleton when fetching diff
        - Render DiffViewer with oldString/newString when diff loaded
        - Extract old/new content from diff string
        - Handle binary files (show "Binary file" message)
- [ ] 12.6 Style status badges
        - M (Modified): blue/yellow
        - A (Added): green
        - D (Deleted): red
        - ??: gray (Untracked)

#### Completion Notes

### 13: Create HistoryView Component

<!-- prettier-ignore -->
- [ ] 13.1 Create HistoryView.tsx component
        - File: `apps/web/src/client/pages/projects/git/components/HistoryView.tsx`
        - Import Button from ui components
        - Import CommitCard component (to be created)
        - Import useCommitHistory hook
        - Import useState for pagination
- [ ] 13.2 Define component props interface
        - projectId: string | undefined
        - expandedCommits: Set<string>
        - onToggleExpand: (commitHash: string) => void
- [ ] 13.3 Implement pagination state
        - State: limit (100), offset (0)
        - Fetch commits with useCommitHistory(projectId, limit, offset)
        - Calculate hasMore based on commits.length === limit
- [ ] 13.4 Build commit list
        - Map over commits array
        - Render CommitCard for each commit
        - Pass: commit, expanded, projectId
        - Pass: onToggleExpand callback
- [ ] 13.5 Build "Load More" button
        - Show at bottom if hasMore
        - onClick increments offset by limit
        - Shows loading state while fetching
- [ ] 13.6 Handle empty state
        - Show "No commits yet" when commits.length === 0
        - Show icon (GitBranch or similar)
        - Center in content area
- [ ] 13.7 Handle loading state
        - Show skeleton cards while loading initial commits

#### Completion Notes

### 14: Create CommitCard Component

<!-- prettier-ignore -->
- [ ] 14.1 Create CommitCard.tsx component
        - File: `apps/web/src/client/pages/projects/git/components/CommitCard.tsx`
        - Import Collapsible, Badge from ui components
        - Import ChevronRight icon from lucide-react
        - Import CommitDiffView component (to be created)
        - Import GitCommit type
- [ ] 14.2 Define component props interface
        - commit: GitCommit
        - expanded: boolean
        - projectId: string | undefined
        - onToggleExpand: () => void
- [ ] 14.3 Build commit card header
        - Collapsible trigger with flex row layout
        - ChevronRight icon (rotates 90deg when expanded)
        - Commit message (truncate if too long)
        - Author + relative date in muted text
        - Short hash in monospace on right side
        - onClick header toggles expand
- [ ] 14.4 Build collapsible content
        - CollapsibleContent wraps CommitDiffView
        - Only render CommitDiffView when expanded
        - Pass: projectId, commitHash
- [ ] 14.5 Style commit card
        - Border, rounded corners
        - Hover state
        - Padding
        - Spacing between cards

#### Completion Notes

### 15: Create CommitDiffView Component

<!-- prettier-ignore -->
- [ ] 15.1 Create CommitDiffView.tsx component
        - File: `apps/web/src/client/pages/projects/git/components/CommitDiffView.tsx`
        - Import useCommitDiff hook
        - Import DiffViewer or create raw diff display
        - Import GitCommitDiff type
- [ ] 15.2 Define component props interface
        - projectId: string | undefined
        - commitHash: string
- [ ] 15.3 Fetch commit diff
        - Use useCommitDiff(projectId, commitHash)
        - Show loading skeleton while fetching
- [ ] 15.4 Build commit metadata section
        - Show full commit hash in monospace
        - Show author name + email
        - Show full date (not relative)
        - Show commit message (full, with line breaks)
- [ ] 15.5 Build change stats section
        - Show "{filesChanged} file(s) changed"
        - Show "+{insertions} insertions" in green
        - Show "-{deletions} deletions" in red
        - Format like: "1 file changed, 17 insertions(+), 38 deletions(-)"
- [ ] 15.6 Build diff display
        - Show raw diff in monospace
        - Or parse and use DiffViewer for each file
        - Syntax highlighting if possible
        - Scroll container with max height

#### Completion Notes

### 16: Create CreateBranchDialog Component

<!-- prettier-ignore -->
- [ ] 16.1 Create CreateBranchDialog.tsx component
        - File: `apps/web/src/client/pages/projects/git/components/CreateBranchDialog.tsx`
        - Import Dialog, DialogContent, DialogHeader components from ui
        - Import Input, Button from ui
        - Import useState for form state
- [ ] 16.2 Define component props interface
        - open: boolean
        - onOpenChange: (open: boolean) => void
        - currentBranch: string | undefined
        - onCreateBranch: (name: string, from?: string) => Promise<void>
- [ ] 16.3 Build form state
        - State: branchName (string), isCreating (boolean)
        - Validate: no spaces, no special chars except dash/underscore
- [ ] 16.4 Build dialog content
        - DialogHeader with title: "Create New Branch"
        - Input for branch name
        - Validation error message if invalid name
        - Info text: "Will automatically switch to new branch after creation"
        - Create button (disabled while isCreating or invalid name)
        - Cancel button
- [ ] 16.5 Implement create handler
        - Set isCreating to true
        - Call onCreateBranch(branchName)
        - On success: close dialog, reset form
        - On error: show error message
        - Set isCreating to false

#### Completion Notes

### 17: Create CreatePullRequestDialog Component

<!-- prettier-ignore -->
- [ ] 17.1 Create CreatePullRequestDialog.tsx component
        - File: `apps/web/src/client/pages/projects/git/components/CreatePullRequestDialog.tsx`
        - Import Dialog, DialogContent, DialogHeader components from ui
        - Import Input, Textarea, Button, Select from ui
        - Import usePrData, useCreatePr hooks
        - Import useState for form state
- [ ] 17.2 Define component props interface
        - open: boolean
        - onOpenChange: (open: boolean) => void
        - projectId: string | undefined
        - currentBranch: string | undefined
- [ ] 17.3 Fetch PR pre-fill data when dialog opens
        - Use usePrData(projectId, baseBranch, open) to fetch when dialog opens
        - Pre-fill title with prData.title
        - Pre-fill description with prData.description
        - Show loading state while fetching
- [ ] 17.4 Build form state
        - State: title (string), description (string), baseBranch (string, default 'main')
        - Update from prData when loaded
- [ ] 17.5 Build dialog content
        - DialogHeader with title: "Create Pull Request"
        - Input for PR title
        - Textarea for PR description (rows: 8)
        - Select for base branch (main, develop, etc.)
        - Info text explaining hybrid approach (tries gh CLI, falls back to web)
        - Create PR button (disabled while creating or !title.trim())
        - Cancel button
- [ ] 17.6 Implement create PR handler
        - Use useCreatePr mutation
        - Call with title, description, baseBranch
        - On success:
          - If prUrl: open in new tab with window.open(prUrl, '_blank')
          - Show toast with success message
          - Close dialog
        - On error: show error message in dialog

#### Completion Notes

### 18: Add Route to App

<!-- prettier-ignore -->
- [ ] 18.1 Register source-control route
        - File: `apps/web/src/client/App.tsx`
        - Import ProjectSourceControl from pages/projects/git
        - Add route inside project detail routes (after files route)
        - Route path: "source-control"
        - Element: <ProjectSourceControl />
        - Save file

#### Completion Notes

### 19: Integration Testing

<!-- prettier-ignore -->
- [ ] 19.1 Test Changes tab workflow
        - Start dev server: `cd apps/web && pnpm dev`
        - Navigate to project with git repo
        - Go to source-control page
        - Make file changes in project
        - Verify files appear in Changes tab
        - Test file selection (checkboxes)
        - Test Select All / Deselect All
        - Test file expand (show diff inline)
        - Enter commit message
        - Test commit button (should be disabled without message or files)
        - Commit changes
        - Verify success toast, selections cleared, git status refreshed
- [ ] 19.2 Test History tab
        - Switch to History tab
        - Verify commits load (up to 100)
        - Click commit to expand
        - Verify commit details show (metadata + stats + diff)
        - Click commit again to collapse
        - Test Load More button if > 100 commits exist
- [ ] 19.3 Test branch operations
        - Click branch selector dropdown
        - Verify current branch highlighted
        - Switch to different branch
        - Verify switch successful, toast shown, status updated
        - Click "Create new branch" in dropdown
        - Enter branch name in dialog
        - Create branch
        - Verify auto-switched to new branch, toast shown
- [ ] 19.4 Test Push/Fetch/Refresh
        - Make commit if ahead count is 0
        - Verify Push button enabled with ahead badge
        - Click Push
        - Verify push successful, toast shown
        - Fetch from remote (if behind)
        - Verify fetch successful, toast shown
        - Click Refresh
        - Verify git status reloaded
- [ ] 19.5 Test PR creation
        - Create branch with commits ahead of main
        - Click "Create PR" button
        - Verify dialog opens with pre-filled title/description
        - Review pre-filled data (should use commit messages)
        - Click Create PR
        - Verify gh CLI attempted (or web fallback)
        - Verify PR URL opens in new tab (or GitHub compare page)
        - Verify success toast
- [ ] 19.6 Test edge cases
        - Navigate to project without git repo
        - Verify graceful handling (show "Not a git repository" message)
        - Test with no changes (empty Changes tab)
        - Test with no commits (empty History tab)
        - Test with invalid branch name in create dialog
        - Test network errors (simulate API failure)
        - Verify error toasts and handling
- [ ] 19.7 Test UI responsiveness
        - Test with many changed files (20+)
        - Test with long commit messages
        - Test with large diffs
        - Verify scrolling works
        - Verify performance acceptable

#### Completion Notes

### 20: Polish and Error Handling

<!-- prettier-ignore -->
- [ ] 20.1 Add comprehensive error handling
        - Wrap all git operations in try-catch
        - Show user-friendly error toasts
        - Handle common errors: permission denied, not a git repo, merge conflicts, push rejected
        - Log errors to console for debugging
- [ ] 20.2 Add loading states
        - Show skeletons while loading git status
        - Show spinners on buttons during mutations
        - Show loading in file diffs while fetching
        - Show loading in commit diffs while fetching
        - Disable interactive elements during loading
- [ ] 20.3 Improve empty states
        - "No changes detected" with icon for Changes tab
        - "No commits yet" with icon for History tab
        - "Not a git repository" with helpful message and icon
        - Style consistently across all empty states
- [ ] 20.4 Add keyboard shortcuts (optional)
        - Ctrl/Cmd+Enter to commit (when focus in commit message)
        - Escape to close dialogs
        - Arrow keys for navigation in lists
- [ ] 20.5 Test accessibility
        - Tab navigation works through all interactive elements
        - Screen reader compatibility (aria labels)
        - Keyboard-only operation possible
        - Focus indicators visible
- [ ] 20.6 Code cleanup
        - Remove any console.logs
        - Remove unused imports
        - Format code consistently
        - Add JSDoc comments to complex functions
        - Ensure all components follow naming conventions

#### Completion Notes

## Acceptance Criteria

**Must Work:**

- [ ] Changes tab displays all uncommitted files (modified, added, deleted, untracked)
- [ ] Files can be individually selected with checkboxes for staging
- [ ] Select All / Deselect All buttons work correctly
- [ ] Clicking file expands to show inline diff using DiffViewer
- [ ] Commit message textarea at top accepts input
- [ ] Commit button disabled when no files selected or no message
- [ ] Committing files succeeds and refreshes status
- [ ] Committed files disappear from Changes tab
- [ ] History tab loads and displays 100 commits at a time
- [ ] Commits can be expanded to show metadata, stats, and full diff
- [ ] Load More button fetches next 100 commits
- [ ] Branch selector dropdown shows all branches with current highlighted
- [ ] Switching branches updates entire UI state
- [ ] Creating new branch auto-switches to it
- [ ] Push button shows ahead count badge and pushes successfully
- [ ] Fetch button shows behind count badge and fetches successfully
- [ ] Refresh button reloads git status
- [ ] Create PR button opens dialog with pre-filled title/description
- [ ] PR creation tries gh CLI, falls back to GitHub web URL
- [ ] PR URL opens in new browser tab
- [ ] All mutations show success/error toasts
- [ ] Auto-refresh git status every 30 seconds
- [ ] Non-git projects show graceful error message

**Should Not:**

- [ ] Allow committing with empty message
- [ ] Allow committing with no files selected
- [ ] Break when project has no commits yet
- [ ] Crash when git operations fail
- [ ] Show stale data after git operations
- [ ] Allow creating branch with invalid name
- [ ] Push when no commits ahead
- [ ] Show confusing errors to users
- [ ] Cause performance issues with large diffs or many commits
- [ ] Lose uncommitted work on navigation
- [ ] Allow concurrent git operations (race conditions)

## Validation

Execute these commands to verify the feature works correctly:

**Automated Verification:**

```bash
# Build verification
cd apps/web && pnpm build
# Expected: Clean build with no TypeScript errors

# Type checking
cd ../.. && pnpm check-types
# Expected: No type errors across monorepo

# Linting
cd apps/web && pnpm lint
# Expected: No linting errors or warnings

# Unit tests (if any created)
cd apps/web && pnpm test
# Expected: All tests pass
```

**Manual Verification:**

1. Start application: `cd apps/web && pnpm dev`
2. Navigate to: `http://localhost:5173/projects/{project-id}/source-control`
3. **Changes Tab Tests:**
   - Make changes to files in project
   - Verify files appear in list with correct status badges (M, A, D, ??)
   - Check/uncheck file checkboxes
   - Click file to expand and verify diff shows correctly
   - Test Select All button
   - Test Deselect All button
   - Type commit message
   - Verify Commit button enables only when files selected and message provided
   - Click Commit
   - Verify success toast, files disappear, status refreshes
4. **History Tab Tests:**
   - Switch to History tab
   - Verify list of commits loads (most recent first)
   - Click commit to expand
   - Verify shows: full hash, author, email, date, message, stats, diff
   - Click again to collapse
   - Scroll to bottom
   - Click "Load More" if available
   - Verify next 100 commits load
5. **Branch Tests:**
   - Click branch dropdown
   - Verify current branch has checkmark
   - Select different branch
   - Verify switch successful, toast shown, UI updates
   - Click "Create new branch" in dropdown
   - Enter name: "test-feature-branch"
   - Click Create
   - Verify auto-switched, toast shown, branch appears in dropdown
6. **Remote Operations:**
   - Make commits (if not ahead)
   - Verify Push button shows ahead count badge
   - Click Push
   - Verify push successful, toast shown, ahead count updates
   - Click Fetch
   - Verify fetch successful, toast shown
   - Click Refresh
   - Verify git status reloads
7. **Pull Request:**
   - Ensure on feature branch with commits
   - Click "Create PR" button
   - Verify dialog opens
   - Verify title pre-filled with recent commit message
   - Verify description pre-filled with all commit messages
   - Select base branch (main)
   - Click Create PR
   - Verify gh CLI attempted or web URL provided
   - Verify new tab opens with GitHub PR page
   - Verify success toast with PR link
8. Check console: No errors or warnings

**Feature-Specific Checks:**

- Test with project that is not a git repository: Should show "Not a git repository" message
- Test with empty git repository (no commits): History tab should show "No commits yet"
- Test with no changed files: Changes tab should show "No changes detected"
- Test with binary files in changes: Should show "Binary file" instead of diff
- Test with very large diff (1000+ lines): Should render without performance issues
- Test branch name validation: Reject names with spaces, special chars
- Test concurrent git operations: Should handle gracefully (disable buttons during operations)
- Test with deleted branches: Should handle gracefully in dropdown
- Test push rejection (force required): Should show clear error message
- Test merge conflicts: Should show clear error message
- Test with detached HEAD state: Should show warning message
- Test auto-refresh: Wait 30 seconds and verify status updates automatically
- Test PR creation without gh CLI: Verify fallback to GitHub compare URL works
- Test network offline: Verify graceful error handling for API failures

## Definition of Done

- [ ] All tasks completed in order
- [ ] Git service extended with all operations (20+ functions)
- [ ] All API routes created and tested (15+ endpoints)
- [ ] Zod schemas validate all requests/responses
- [ ] React Query hooks implemented for all operations (15+ hooks)
- [ ] Main ProjectSourceControl page fully functional with tabs
- [ ] Changes tab complete with file list, diffs, commit controls
- [ ] History tab complete with commit list, pagination, expandable diffs
- [ ] GitTopBar component complete with branch selector and action buttons
- [ ] All UI components created (8 components)
- [ ] Branch creation/switching works correctly
- [ ] Push/Fetch operations work correctly
- [ ] PR creation works with hybrid approach (gh CLI + web fallback)
- [ ] Route registered in App.tsx
- [ ] All acceptance criteria met
- [ ] Manual testing confirms all workflows work
- [ ] Type checks pass with no errors
- [ ] Lint checks pass with no warnings
- [ ] Build succeeds with no errors
- [ ] No console errors during usage
- [ ] Error handling comprehensive with user-friendly messages
- [ ] Loading states implemented throughout
- [ ] Empty states styled and informative
- [ ] Code follows existing patterns (functional components, React Query, local state)
- [ ] Performance acceptable with large repos and diffs

## Notes

- simple-git library already installed and used in existing git.service.ts for getCurrentBranch
- Reuses existing DiffViewer component from sessions feature - no modifications needed
- API routes follow existing project routes pattern (/api/projects/:id/...)
- React Query hooks follow existing useProjects, useAgentSessions patterns
- Component organization follows feature-based structure (pages/projects/git/*)
- Local state preferred over Zustand for this feature (per requirements)
- Auto-refresh every 30s prevents stale git status display
- gh CLI detection allows graceful fallback to web-based PR creation
- Pre-filling PR data improves UX by using existing commit messages
- Tab state management simple with useState (no complex routing needed)
- Pagination in History tab prevents loading thousands of commits at once
- Inline diffs inspired by VSCode source control UX
- Future consideration: Add git stash support
- Future consideration: Add git revert/reset operations (with warnings)
- Future consideration: Add visual git graph/tree view
- Future consideration: Add diff syntax highlighting (currently just +/- colors)
- Future consideration: Add git blame integration
- Future consideration: Add submodule support
- Security: All git operations scoped to project.path, no arbitrary path execution
- Performance: React Query caching reduces redundant git operations
- Accessibility: Keyboard navigation, screen reader support, focus management
